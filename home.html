<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">Felda</h1>
      </div><!-- /.col -->
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item">Felda</li>
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </div><!-- /.col -->
    </div><!-- /.row -->
  </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->

<!-- Main content -->
<div class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-9">
                <div class="form-group">
                  <label>Date range button:</label>

                  <div class="input-group">
                    <button type="button" class="btn btn-default float-right" id="daterange-btn">
                      <i class="far fa-calendar-alt"></i> Date range picker
                      <i class="fas fa-caret-down"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Heatmap</h3>
        </div>
        <div class="card-body">
          <div id="heatmapContainerWrapper" style="width:100%; height:100%;">
            <div id="heatmapContainer" style="width:100%; height:800px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- /.container-fluid -->
</div>
<!-- /.content -->
  
<script>
$(function () {
  //Date range as a button
  $('#daterange-btn').daterangepicker(
    {
      ranges   : {
        'Today'       : [moment(), moment()],
        'Yesterday'   : [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
        'Last 7 Days' : [moment().subtract(6, 'days'), moment()],
        'Last 30 Days': [moment().subtract(29, 'days'), moment()],
        'This Month'  : [moment().startOf('month'), moment().endOf('month')],
        'Last Month'  : [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
      },
      startDate: moment().subtract(29, 'days'),
      endDate  : moment()
    },
    function (start, end) {
      var startFormatted = formatDate(start) + " 00:00:00";
      var endFormatted = formatDate(end) + " 23:59:59";
      
      $.post('php/getmonthly.php', {startDate: startFormatted, endDate: endFormatted}, function(data){
        var obj = JSON.parse(data);

        if(obj.status === 'success'){
          heatmap.setData({
            max: 100,
            min: 0,
            data: [
              {
                x: 0.53 * width >> 0,
                y: 0.75 * height >> 0,
                value: (obj.totalE1 / obj.totalCount) * 1000,
                radius: 100
              }, 
              {
                x: 0.4 * width >> 0,
                y: 0.75 * height >> 0,
                value: (obj.totalE2 / obj.totalCount) * 1000,
                radius: 100
              },
              {
                x: 0.35 * width >> 0,
                y: 0.28 * height >> 0,
                value: (obj.totalE3 / obj.totalCount) * 1000,
                radius: 100
              }, 
              {
                x: 0.18 * width >> 0,
                y: 0.15 * height >> 0,
                value: (obj.totalE5 / obj.totalCount) * 1000,
                radius: 100
              },
              {
                x: 0.7 * width >> 0,
                y: 0.93 * height >> 0,
                value: (obj.totalC1 / obj.totalCount) * 1000,
                radius: 100
              }, 
              {
                x: 0.63 * width >> 0,
                y: 0.8 * height >> 0,
                value: (obj.totalC2 / obj.totalCount) * 1000,
                radius: 100
              }, 
              {
                x: 0.33 * width >> 0,
                y: 0.7 * height >> 0,
                value: (obj.totalC3 / obj.totalCount) * 1000,
                radius: 100
              }
            ]
          });
        }
        else if(obj.status === 'failed'){
          toastr["error"](obj.message, "Failed:");
        }
        else{
          toastr["error"]("Something wrong when geting data", "Failed:");
        }
      });
    }
  );

  var heatmap = h337.create({
    container: document.getElementById('heatmapContainer'),
    // a waterdrop gradient ;-)
    gradient: { 
      0.25: "cyan", 
      0.5: "yellow", 
      0.75: "orange", 
      1: 'red'},
    maxOpacity: .6,
    radius: 10,
    blur: .90
  });

  // boundaries for data generation
  var width = (+window.getComputedStyle(document.getElementsByClassName('heatmap-canvas')[0]).width.replace(/px/,''));
  var height = (+window.getComputedStyle(document.getElementsByClassName('heatmap-canvas')[0]).height.replace(/px/,''));
  $('#heatmapContainer').find('.heatmap-canvas').css('background-image', 'url("images/floor.png")');
  $('#heatmapContainer').find('.heatmap-canvas').css('background-repeat', 'no-repeat');
  $('#heatmapContainer').find('.heatmap-canvas').css('background-size', '100% auto');

  $.post('php/getmonthly.php', {startDate: formatDate(moment().subtract(29, 'days')) + " 00:00:00", endDate: formatDate(moment()) + " 23:59:59"}, function(data){
    var obj = JSON.parse(data);

    if(obj.status === 'success'){
      heatmap.setData({
        max: 100,
        min: 0,
        data: [
          {
            x: 0.53 * width >> 0,
            y: 0.75 * height >> 0,
            value: (obj.totalE1 / obj.totalCount) * 1000,
            radius: 100
          }, 
          {
            x: 0.4 * width >> 0,
            y: 0.75 * height >> 0,
            value: (obj.totalE2 / obj.totalCount) * 1000,
            radius: 100
          },
          {
            x: 0.35 * width >> 0,
            y: 0.28 * height >> 0,
            value: (obj.totalE3 / obj.totalCount) * 1000,
            radius: 100
          }, 
          {
            x: 0.18 * width >> 0,
            y: 0.15 * height >> 0,
            value: (obj.totalE5 / obj.totalCount) * 1000,
            radius: 100
          },
          {
            x: 0.7 * width >> 0,
            y: 0.93 * height >> 0,
            value: (obj.totalC1 / obj.totalCount) * 1000,
            radius: 100
          }, 
          {
            x: 0.63 * width >> 0,
            y: 0.8 * height >> 0,
            value: (obj.totalC2 / obj.totalCount) * 1000,
            radius: 100
          }, 
          {
            x: 0.33 * width >> 0,
            y: 0.7 * height >> 0,
            value: (obj.totalC3 / obj.totalCount) * 1000,
            radius: 100
          }
        ]
      });
    }
    else if(obj.status === 'failed'){
      toastr["error"](obj.message, "Failed:");
    }
    else{
      toastr["error"]("Something wrong when geting data", "Failed:");
    }
  });
});
</script>
  